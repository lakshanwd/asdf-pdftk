#!/usr/bin/env bash

set -euo pipefail

current_script_path=${BASH_SOURCE[0]}
plugin_dir=$(dirname "$(dirname "$current_script_path")")

# shellcheck source=./lib/utils.bash
. "${plugin_dir}/lib/utils.bash"

# GitLab API endpoint for releases
# Using project ID 5024297 (from utils.bash download_release function)
GITLAB_API_URL="https://gitlab.com/api/v4/projects/5024297/releases"

# Fetch the latest release using GitLab API
# The API returns releases sorted by released_at in descending order by default
if command -v jq >/dev/null 2>&1; then
	# Use jq if available for more reliable JSON parsing
	version=$(curl -fsSL "$GITLAB_API_URL?per_page=1" | jq -r '.[0].tag_name // empty' | sed 's/^v//')
else
	# Fallback to grep/sed if jq is not available
	version=$(curl -fsSL "$GITLAB_API_URL?per_page=1" | grep -o '"tag_name":"[^"]*"' | head -1 | sed 's/"tag_name":"//;s/"//' | sed 's/^v//')
fi

# If API call fails or returns empty, fall back to listing all versions
if [[ -z "$version" ]]; then
	version="$(list_all_versions | sort_versions | tail -n1 | xargs echo)"
fi

printf "%s\n" "$version"
